<script>
  Vue.component('v-select', VueSelect.VueSelect)

  let nav = new Vue({
    el: '.nav_select',
    data: <%= fill_vue_data(nil, {
      texts: 'search',
      readyToChange: false,
      list_values: 'year city',
      mainFilters: ['year', 'city'],
      lists: 'years cities',
      params: @params
    }, 'app') %>,
    
    mounted() {
      this.mainFilters.forEach( f => {
        if (this.params[f] != undefined) {
          this[f] = this.params[f]
          let p = this[f]
        }
      })
    },

    created() {
      this.search = this.params.search
      setTimeout(() => {this.readyToChange = true}, 100)
    },

    watch: {
      year(newValue, oldVal) {  
        if (newValue == undefined) return
        if (typeof(oldVal) == 'object' && newValue == oldVal.value) return

        sortable_prepare({})
        if (this.readyToChange) delay('sortable_query({})', 700)
      },

      city(newValue, oldVal) {
        if (this.city == undefined) return
        if (typeof(oldVal) == 'object' && newValue == oldVal.value) return
        sortable_prepare({city: newValue.value})
        if (this.readyToChange) delay('sortable_query({})', 700)
        // $.ajax({
        //   type: "POST",
        //   url: "/ajax/set_city",
        //   data: {city: this.city.value},
        //   dataType: "json",
        //   encode: true
        // })
        // delay('document.location.reload(true)', 400)
      }
    },
  })
</script>